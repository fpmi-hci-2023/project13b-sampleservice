name: Deployment - k8s

on:
  workflow_dispatch: # manual trigger
    inputs:
      build_src:
        description: "Src version to build. For GitTag: \"tag:[name]\", For GitBranch: \"branch:[name]\", For GitCommit: \"commit:[hash]\", For EcrTag: \"ecr:[tag]\", For PullRequest: \"pr:[number]\""
        required: false
        default: 'branch:main'

permissions:
  deployments: write
  id-token: write
  contents: read
  packages: write

jobs:
  build_and_push:
    uses: "fpmi-hci-2023/project13b-chatgpt/.github/workflows/docker_build_and_publish.yaml@main"
    with:
      name: servicediscovery
      build_src: ${{ github.event.inputs.build_src }}
    secrets:
      gh_sudo_token: ${{ secrets.GH_SUDO_TOKEN }}
  deploy:
    uses: "fpmi-hci-2023/project13b-chatgpt/.github/workflows/k8s_deploy.yaml@main"
    needs: build_and_push
    with:
      name: servicediscovery
      image_tag: ${{ needs.build_and_push.outputs.image_tag }}
      k8s_cluster_name: ${{ vars.K8S_CLUSTER }}
    secrets:
      gh_sudo_token: ${{ secrets.GH_SUDO_TOKEN }}